<!doctype html>
<html lang="en" itemscope itemtype="http://schema.org/Article">

    <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create a File Upload Class in PHP - Arka Roy</title>
    <meta name="description" content="The basic process of providing a HTML form for uploading user submitted files to the server with PHP is fairly easy and simple. But there are some security implications that many of us are unaware of. We will be building a custom PHP class for secure file upload. This class will check the type and size of the file and rename the file in case of duplication.

">
    <meta name="author" content="Arka Roy">
    <meta name="google-site-verification" content="Hoal6De7aoiiqdo7jTEmhXXXJo571pQuGeRjB3hY3-c">
    <meta name="msvalidate.01" content="AECE4670236DEBC0B41933B8F9A56547">
    <meta name="yandex-verification" content="5f83a425d7a76ae8">
    <meta name="p:domain_verify" content="a2b47611cc9905cb28e8b90214a6026b">
    <meta name="alexaVerifyID" content="sFRbCPL8KD91Vlkp8gjHT1-yX_o">
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link href="http://www.arkaroy.net/feed.xml" rel="alternate" type="application/atom+xml" title="Arka Roy">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/image/icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/image/icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/image/icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/image/icon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/image/icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/image/icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/image/icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/image/icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/image/icon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/image/icon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/image/icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/image/icon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/image/icon/favicon-16x16.png">
    <!--
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    -->

    <link rel="author" href="https://plus.google.com/+ArkaRoyGPlus">
    <meta property="fb:admins" content="100000470507339">

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="Create a File Upload Class in PHP - Arka Roy">
    <meta itemprop="description" content="The basic process of providing a HTML form for uploading user submitted files to the server with PHP is fairly easy and simple. But there are some security implications that many of us are unaware of. We will be building a custom PHP class for secure file upload. This class will check the type and size of the file and rename the file in case of duplication.

">
    <meta itemprop="image" content="http://www.arkaroy.net/assets/image/default-thumbnail.jpg">

    <!-- Open Graph data for Facebook -->
    <meta property="og:title" content="Create a File Upload Class in PHP - Arka Roy">
    <meta property="og:image" content="http://www.arkaroy.net/assets/image/default-thumbnail.jpg">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://www.arkaroy.net/blog/create-file-upload-class-in-php/">
    <meta property="og:description" content="The basic process of providing a HTML form for uploading user submitted files to the server with PHP is fairly easy and simple. But there are some security implications that many of us are unaware of. We will be building a custom PHP class for secure file upload. This class will check the type and size of the file and rename the file in case of duplication.

">

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="http://www.arkaroy.net/blog/create-file-upload-class-in-php/">
    <meta name="twitter:title" content="Create a File Upload Class in PHP - Arka Roy">
    <meta name="twitter:description" content="The basic process of providing a HTML form for uploading user submitted files to the server with PHP is fairly easy and simple. But there are some security implications that many of us are unaware of. We will be building a custom PHP class for secure file upload. This class will check the type and size of the file and rename the file in case of duplication.

">
    <meta name="twitter:image" content="http://www.arkaroy.net/assets/image/default-thumbnail.jpg">
    <meta name="twitter:site" content="@iarkaroy">
    <meta name="twitter:creator" content="@iarkaroy">

    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-61692534-1', 'auto');
        ga('send', 'pageview');

    </script>
</head>

    <body>
        

        <div class="page-wrapper">
            
            <div class="page-header">
                <div class="display-table">

    
    <header class="display-cell">

        <a href="http://www.arkaroy.net" class="logo">
            <i class="icon-arkaroy-logo"></i>
            <span>Arka Roy</span>
        </a>

        <p>I'm a passionate and proficient web designer and application developer residing in Kolkata, India.</p>

        <nav class="main-nav">

            <ul class="main-menu list-inline">
                <li><a href="/about/">About</a></li>
                <li class="menu-separator"></li>
                <li><a href="/portfolio/">Portfolio</a></li>
                <li class="menu-separator"></li>
                <li><a href="/blog/">Blog</a></li>
                <li class="menu-separator"></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>                

        </nav>

    </header>
    

</div>
            </div>
            
            <div class="page-content">
                <form action="/search" method="get" class="search-form">
    <label class="search-label"><i class="fa fa-search"></i></label>
    <input type="text" name="q" class="search-q" placeholder="Search..." autocomplete="off">
    <button type="submit">Search</button>
</form>

<div class="entry post-entry single">

    <header class="entry-header">
        <h1 class="entry-title">Create a File Upload Class in PHP</h1>
        <p class="entry-meta"><em>Sep 29, 2013 by Arka Roy</em></p>
        <div class="social-share clearfix" data-url="http://www.arkaroy.net/blog/create-file-upload-class-in-php/">
    
    <a class="twitter" href="https://twitter.com/intent/tweet?text=Create a File Upload Class in PHP&url=http://www.arkaroy.net/blog/create-file-upload-class-in-php/&via=iarkaroy&related=iarkaroy" rel="nofollow" target="_blank" title="Share this on Twitter">
        <i class="fa fa-twitter"></i>
        <span class="shares-twitter">0</span>
    </a>
    
    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?t=Create a File Upload Class in PHP&u=http://www.arkaroy.net/blog/create-file-upload-class-in-php/" rel="nofollow" target="_blank" title="Share this on Facebook">
        <i class="fa fa-facebook"></i>
        <span class="shares-facebook">0</span>
    </a>
    
    <a class="googleplus" href="https://plus.google.com/share?url=http://www.arkaroy.net/blog/create-file-upload-class-in-php/" rel="nofollow" target="_blank" title="Share this on Google Plus">
        <i class="fa fa-google-plus"></i>
        <span class="shares-googleplus">0</span>
    </a>
    
    <a class="linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Create a File Upload Class in PHP&url=http://www.arkaroy.net/blog/create-file-upload-class-in-php/" rel="nofollow" target="_blank" title="Share this on LinkedIn">
        <i class="fa fa-linkedin"></i>
        <span class="shares-linkedin">0</span>
    </a>
    
</div>
        
        <br>
        
    </header>

    <article class="entry-content">
        <p>The basic process of providing a HTML form for uploading user submitted files to the server with PHP is fairly easy and simple. But there are some security implications that many of us are unaware of. We will be building a custom PHP class for secure file upload. This class will check the type and size of the file and rename the file in case of duplication.</p>

<p>Those who are absolutely beginner in handling file upload, are requested to take a look at <a href="http://www.arkaroy.net/blog/enhance-file-upload-security-with-php/">Enhance File Upload Security with PHP</a>. That article will help you to better understand file uploading from scratch.</p>

<h2 id="the-class">The Class</h2>

<p>We will start our <code>Upload</code> class with a blank constructor</p>

<pre><code>class Upload {
    function __construct() {

    }
}
</code></pre>

<p>Now we will add some properties to our class to store some data.</p>

<pre><code>protected $config = array();
protected $current;
protected $errors = array();
protected $new_name;
</code></pre>

<p>The <code>$config</code> property holds the configurations like target directory, size limit etc. <code>$current</code> refers to the current key of <code>$_FILES</code> array. <code>$errors</code> contains the errors encountered during process. <code>$new_name</code> stores the name of the uploaded file to be set.</p>

<h2 id="public-methods">Public Methods</h2>

<p>Now we are going to define some public methods to set up some configuration settings.</p>

<p>But first, we need to implement a method for handling errors.</p>

<pre><code>public function error($msg = null) {
    if ($msg) {
        $this-&gt;errors[] = $msg;
        return $this;
    } else {
        return $this-&gt;errors;
    }
}
</code></pre>

<p>This method will store error messages in the <code>$errors</code>. This method will work as both a getter and setter.</p>

<h3 id="extensions">Extensions</h3>

<p>Of course you want to prevent the users from uploading specified types of files. Here is the method for allowing or disallowing file types.</p>

<pre><code>public function setAllowedExtensions($extensions) {
    if (is_array($extensions)) {
        $this-&gt;config['allowed_extensions'] = $extensions;
    } else {
        $extensions = explode(',', $extensions);
        $this-&gt;config['allowed_extensions'] = array();
        foreach ($extensions as $ext) {
            $this-&gt;config['allowed_extensions'][] = trim($ext);
        }
    }
    return $this;
}

public function setDisallowedExtensions($extensions) {
    if (is_array($extensions)) {
        $this-&gt;config['disallowed_extensions'] = $extensions;
    } else {
        $extensions = explode(',', $extensions);
        $this-&gt;config['disallowed_extensions'] = array();
        foreach ($extensions as $ext) {
            $this-&gt;config['disallowed_extensions'][] = trim($ext);
        }
    }
    return $this;
}
</code></pre>

<p>The allowed extensions will be stored in <code>$config['allowed_extensions']</code> and the disallowed extensions in <code>$config['disallowed_extensions']</code>. You can either specify allowed file types or disallowed file types.</p>

<h3 id="target-directory">Target Directory</h3>

<p>Now its time to specify where our uploaded images will live. We should add a method to setup this setting.</p>

<pre><code>public function setDirectory($dir) {
    $dir = str_replace('\\', '/', $dir);
    $dir = rtrim($dir, '/');
    $this-&gt;config['directory'] = $dir;
    return $this;
}
</code></pre>

<h3 id="max-size">Max Size</h3>

<p>Obviously we want to limit the size of the files to be uploaded. But our specified limit cannot be greater than that specified in PHP config.</p>

<pre><code>public function setMaxSize($size) {
    $max_size = $this-&gt;convertSizeToBytes($size);
    $upload_max_filesize = $this-&gt;convertSizeToBytes(ini_get('upload_max_filesize'));
    $this-&gt;config['max_size'] = ($max_size &lt;= $upload_max_filesize) ? $max_size : $upload_max_filesize;
    return $this;
}
</code></pre>

<p>This will check the size limit from PHP configuration. If the specified limit is larger, it will automatically set the size from PHP config. For this method to work properly, we need to implement a helper method.</p>

<pre><code>protected function convertSizeToBytes($size) {
    $size = trim($size);
    $unit = strtoupper($size[strlen($size) - 1]);
    if (in_array($unit, array('T', 'G', 'M', 'K', 'B'))) {
        switch ($unit) {
            case 'T':
                $size *= 1024;
            case 'G':
                $size *= 1024;
            case 'M':
                $size *= 1024;
            case 'K':
                $size *= 1024;
            case 'B':
                $size *= 1;
        }
    }
    return $size;
}
</code></pre>

<h3 id="overwrite">Overwrite</h3>

<p>We need provide a way to specify whether we want to overwrite files or not.</p>

<pre><code>public function setOverwrite($overwrite = TRUE) {
    $this-&gt;config['overwrite'] = $overwrite;
    return $this;
}
</code></pre>

<h2 id="methods-for-the-magic">Methods for the Magic</h2>

<p>The methods mentioned till now are going to be used to set the configuration settings. For the actual file uploading process, we need to add a few more internal methods to check the settings or generate a new name for the file or upload the file etc.</p>

<pre><code>// Check whether the file is of allowed type
protected function allowedExtension() {
    $allowed = TRUE;
    if (!isset($this-&gt;config['allowed_extensions']) || !$this-&gt;config['allowed_extensions']) {
        $allowed = TRUE;
    }
    if (!isset($this-&gt;config['disallowed_extensions']) || !$this-&gt;config['disallowed_extensions']) {
        $allowed = TRUE;
    }
    $ext = pathinfo($this-&gt;current['name'], PATHINFO_EXTENSION);
    $ext = strtolower($ext);
    if (isset($this-&gt;config['allowed_extensions']) &amp;&amp; $this-&gt;config['allowed_extensions']) {
        $allowed = in_array($ext, $this-&gt;config['allowed_extensions']);
    }
    if (isset($this-&gt;config['disallowed_extensions']) &amp;&amp; $this-&gt;config['disallowed_extensions']) {
        $allowed = !in_array($ext, $this-&gt;config['disallowed_extensions']);
    }
    return $allowed;
}

// Check whether the file is within size limit
protected function allowedSize() {
    $size = $this-&gt;current['size'];
    return $size &lt;= $this-&gt;config['max_size'];
}

// Validate the target directory
protected function checkDirectory() {
    if (!isset($this-&gt;config['directory']) || empty($this-&gt;config['directory'])) {
        return FALSE;
    }
    if (!is_dir($this-&gt;config['directory'])) {
        mkdir($this-&gt;config['directory']);
    }
    return is_writable($this-&gt;config['directory']);
}

// Generate new name for the file to be saved
// it will replace spaces with dashes
// name will be lowercase
// generate new name if file exists
protected function setNewName() {
    $filename = $this-&gt;current['name'];
    $name = pathinfo($filename, PATHINFO_FILENAME);
    $ext = pathinfo($filename, PATHINFO_EXTENSION);
    $name = str_replace(' ', '-', $name);
    $name = strtolower($name);
    $this-&gt;new_name = $name . '.' . $ext;
    if (isset($this-&gt;config['overwrite']) &amp;&amp; $this-&gt;config['overwrite']) {
        return $this;
    }
    $count = 0;
    while (file_exists($this-&gt;config['directory'] . '/' . $this-&gt;new_name)) {
        $count++;
        $this-&gt;new_name = $name . '_' . $count . '.' . $ext;
    }
    return $this;
}

// Move uploaded file with new name
protected function moveFile() {
    $this-&gt;setNewName();
    return move_uploaded_file($this-&gt;current['tmp_name'], $this-&gt;config['directory'] . '/' . $this-&gt;new_name);
}

// Sets error messages according to upload error
protected function uploadError() {
    switch ($this-&gt;current['error']) {
        case 1:
        case 2:
            $this-&gt;error('The file is bigger than specified limit.');
            break;
        case 3:
            $this-&gt;error('The file is uploaded partially. Please try again.');
            break;
        case 4:
            $this-&gt;error('No file selected to upload.');
            break;
        case 6:
            $this-&gt;error('No upload directory has been specified.');
            break;
        default :
            $this-&gt;error('Failed to upload the file.');
            break;
    }
}

// Public method to execute the upload process
public function run() {
    $this-&gt;current = current($_FILES);
    if ($this-&gt;current['error'] != 0) {
        $this-&gt;uploadError();
        return FALSE;
    }
    if (!$this-&gt;allowedExtension()) {
        $this-&gt;error('The type of the file is not supported.');
        return FALSE;
    }
    if (!$this-&gt;allowedSize()) {
        $this-&gt;error('The size of the file is bigger than limit.');
        return FALSE;
    }
    if (!$this-&gt;checkDirectory()) {
        $this-&gt;error('Unable to access upload directory');
        return FALSE;
    }
    if ($this-&gt;moveFile()) {
        return $this-&gt;new_name;
    }
    return FALSE;
}
</code></pre>

<h2 id="adding-power-to-the-constructor">Adding power to the Constructor</h2>

<p>While we are able set configuration settings by calling respective methods, it will be more comprehensive if we can provide an option to set the configuration in the constructor.</p>

<pre><code>function __construct($config = array()) {
    if ($config &amp;&amp; !is_array($config)) {
        return FALSE;
    }
    foreach ($config as $option =&gt; $value) {
        $parts = explode('_', $option);
        $cap = array_map('ucfirst', $parts);
        $method = 'set' . implode("", $cap);
        if (method_exists($this, $method)) {
            call_user_func_array(array($this, $method), (array) $value);
        }
    }
}
</code></pre>

<h2 id="usage">Usage</h2>

<p>To use this class, lets have a form first.</p>

<pre><code>&lt;form action="&lt;?php echo $_SERVER['PHP_SELF']; ?&gt;" method="post" enctype="multipart/form-data"&gt;
    &lt;label for="file"&gt;Select File:&lt;/label&gt;
    &lt;input type="file" name="file" id="file"&gt;
    &lt;input type="submit" name="upload" value="Upload File"&gt;
&lt;/form&gt;
</code></pre>

<p>Add following lines of code at the top of the document.</p>

<pre><code>if(isset($_POST['upload'])) {
    require 'upload.php';
    $upload = new Upload([
        'overwrite' =&gt; FALSE,
        'max_size' =&gt; '5M',
        'directory' =&gt; __DIR__ . '/uploads/',
        'disallowed_extensions' =&gt; 'exe, bin, sh, py',
    ]);
    $response = $upload-&gt;run();
    if(!$response) {
        $errors = $upload-&gt;error();
    }
}
</code></pre>

    </article>
    
    <div class="tags">
    
        
        
        
        
        
        
        
        
        
    
    </div>
    
</div>

<div class="social-share clearfix" data-url="http://www.arkaroy.net/blog/create-file-upload-class-in-php/">
    
    <a class="twitter" href="https://twitter.com/intent/tweet?text=Create a File Upload Class in PHP&url=http://www.arkaroy.net/blog/create-file-upload-class-in-php/&via=iarkaroy&related=iarkaroy" rel="nofollow" target="_blank" title="Share this on Twitter">
        <i class="fa fa-twitter"></i>
        <span class="shares-twitter">0</span>
    </a>
    
    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?t=Create a File Upload Class in PHP&u=http://www.arkaroy.net/blog/create-file-upload-class-in-php/" rel="nofollow" target="_blank" title="Share this on Facebook">
        <i class="fa fa-facebook"></i>
        <span class="shares-facebook">0</span>
    </a>
    
    <a class="googleplus" href="https://plus.google.com/share?url=http://www.arkaroy.net/blog/create-file-upload-class-in-php/" rel="nofollow" target="_blank" title="Share this on Google Plus">
        <i class="fa fa-google-plus"></i>
        <span class="shares-googleplus">0</span>
    </a>
    
    <a class="linkedin" href="http://www.linkedin.com/shareArticle?mini=true&title=Create a File Upload Class in PHP&url=http://www.arkaroy.net/blog/create-file-upload-class-in-php/" rel="nofollow" target="_blank" title="Share this on LinkedIn">
        <i class="fa fa-linkedin"></i>
        <span class="shares-linkedin">0</span>
    </a>
    
</div>

<br>

<div class="posts-nav-links clearfix">
    
    <a href="/blog/enhance-file-upload-security-with-php/" class="next-post-link" title="Enhance File Upload Security with PHP">
        <h4>Previous Post</h4>
        <h5>Enhance File Upload Security with PHP</h5>
    </a>
    
    
    <a href="/blog/how-to-add-scalable-vector-graphics-svg-to-web-page/" class="previous-post-link" title="How to Add Scalable Vector Graphics (SVG) to Web Page">
        <h4>Next Post</h4>
        <h5>How to Add Scalable Vector Graphics (SVG) to Web Page</h5>
    </a>
    
</div>
                <footer class="page-footer">
    <ul class="footer-menu list-inline">
        <li><i class="fa fa-copyright fa-fw"></i> 2015 Arka Roy</li>
        <li class="menu-separator"></li>
        <li><a href="http://www.facebook.com/iarkaroy" target="_blank" title="Facebook">Facebook</a></li>
        <li class="menu-separator"></li>
        <li><a href="http://www.twitter.com/iarkaroy" target="_blank" title="Twitter">Twitter</a></li>
        <li class="menu-separator"></li>
        <li><a href="https://plus.google.com/+ArkaRoyGPlus" target="_blank" title="Google+">Google+</a></li>
        <li class="menu-separator"></li>
        <li><a href="https://www.linkedin.com/in/iarkaroy" target="_blank" title="LinkedIn">LinkedIn</a></li>
        <li class="menu-separator"></li>
        <li><a href="http://www.behance.net/iarkaroy" target="_blank" title="Behance">Behance</a></li>
        <li class="menu-separator"></li>
        <li><a href="http://www.github.com/iarkaroy" target="_blank" title="Github">Github</a></li>
    </ul>    
</footer>

<!-- jQuery from CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="/assets/js/script.js"></script>
<script src="/assets/js/search.js"></script>
<script src="/assets/js/social-popularity-analyzer.js"></script>
            </div>        
            
        </div>
        

    </body>
</html>